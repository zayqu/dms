{"ast":null,"code":"import _objectSpread from\"C:/Users/mazik/AppData/Roaming/npm/node_modules/react-scripts/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";// File: dms/client/src/utils/syncQueue.js\n// REPLACE previous localforage-only version.\n// It keeps localforage queue and ALSO writes a SW-readable copy (via idb sw_requests)\n// It tries to upload to server; if server returns 5xx or network fails, it attempts to POST to /api/pending\nimport localforage from'localforage';import{addSwRequest,deleteSwRequest}from'./sw-idb';const QUEUE_KEY='dms_sync_queue_v2';const PROCESSING_FLAG='dms_sync_processing_v2';localforage.config({name:'dms',storeName:'sync_queue'});async function _readQueue(){const q=await localforage.getItem(QUEUE_KEY);return Array.isArray(q)?q:[];}async function _writeQueue(arr){await localforage.setItem(QUEUE_KEY,arr||[]);}export async function getQueue(){return await _readQueue();}export async function enqueue(type,payload){const q=await _readQueue();const id=\"\".concat(Date.now(),\"_\").concat(Math.random().toString(36).slice(2,9));const item={id,type,payload,createdAt:new Date().toISOString()};q.push(item);await _writeQueue(q);// also write SW copy for replay\ntry{await addSwRequest(item);}catch(e){console.warn('addSwRequest failed',e);}// try to register background sync\nif('serviceWorker'in navigator&&'SyncManager'in window){try{const reg=await navigator.serviceWorker.ready;await reg.sync.register('dms-sync');}catch(e){console.warn('sync register failed',e);}}if(navigator.onLine)processQueue().catch(()=>{});return id;}export async function removeItemById(id){// remove from both localforage queue and SW idb store\nconst q=await _readQueue();const filtered=q.filter(it=>it.id!==id);await _writeQueue(filtered);try{await deleteSwRequest(id);}catch(e){/* ignore */}}async function _isProcessing(){return!!(await localforage.getItem(PROCESSING_FLAG));}async function _setProcessing(val){if(val)await localforage.setItem(PROCESSING_FLAG,true);else await localforage.removeItem(PROCESSING_FLAG);}export async function processQueue(){if(await _isProcessing())return;await _setProcessing(true);try{let q=await _readQueue();if(!q.length)return;for(const item of[...q]){try{if(item.type==='transaction'){const token=localStorage.getItem('token');const res=await fetch(\"\".concat(process.env.REACT_APP_API_BASE||'http://localhost:4000',\"/api/transactions\"),{method:'POST',headers:_objectSpread({'Content-Type':'application/json'},token?{Authorization:\"Bearer \".concat(token)}:{}),body:JSON.stringify(item.payload)});if(!res.ok){// If client is authorized and server returns 5xx (server error), push to server-side pending queue\nif(res.status>=500){try{const uploadRes=await fetch(\"\".concat(process.env.REACT_APP_API_BASE||'http://localhost:4000',\"/api/pending\"),{method:'POST',headers:_objectSpread({'Content-Type':'application/json'},token?{Authorization:\"Bearer \".concat(token)}:{}),body:JSON.stringify({type:item.type,payload:item.payload})});if(uploadRes.ok){// remove local queued item and SW stored request\nawait removeItemById(item.id);q=await _readQueue();continue;}}catch(e){/* can't reach server to create pending */}}// 401 -> wipe auth and stop processing\nif(res.status===401){localStorage.removeItem('token');localStorage.removeItem('user');throw new Error('Unauthorized');}// 4xx invalid -> drop it\nif(res.status>=400&&res.status<500){await removeItemById(item.id);q=await _readQueue();continue;}throw new Error('Server error '+res.status);}// success: remove both stores (localforage & sw idb)\nawait removeItemById(item.id);q=await _readQueue();// also remove SW copy to avoid double send\ntry{await deleteSwRequest(item.id);}catch(e){/* ignore */}continue;}else{// unknown type -> remove\nawait removeItemById(item.id);q=await _readQueue();continue;}}catch(err){console.warn('Queue processing stopped:',err&&err.message?err.message:err);break;}}}finally{await _setProcessing(false);}}export function startQueueProcessor(){let opts=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(navigator.onLine)processQueue().catch(()=>{});window.addEventListener('online',()=>processQueue().catch(()=>{}));document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible'&&navigator.onLine)processQueue().catch(()=>{});});if(opts.intervalMs&&Number(opts.intervalMs)>0)setInterval(()=>{if(navigator.onLine)processQueue().catch(()=>{});},Number(opts.intervalMs));}export async function flush(){await _writeQueue([]);try{const db=await(await import('./sw-idb')).getDb();await db.clear('sw_requests');}catch(e){/* ignore */}}","map":{"version":3,"names":["localforage","addSwRequest","deleteSwRequest","QUEUE_KEY","PROCESSING_FLAG","config","name","storeName","_readQueue","q","getItem","Array","isArray","_writeQueue","arr","setItem","getQueue","enqueue","type","payload","id","concat","Date","now","Math","random","toString","slice","item","createdAt","toISOString","push","e","console","warn","navigator","window","reg","serviceWorker","ready","sync","register","onLine","processQueue","catch","removeItemById","filtered","filter","it","_isProcessing","_setProcessing","val","removeItem","length","token","localStorage","res","fetch","process","env","REACT_APP_API_BASE","method","headers","_objectSpread","Authorization","body","JSON","stringify","ok","status","uploadRes","Error","err","message","startQueueProcessor","opts","arguments","undefined","addEventListener","document","visibilityState","intervalMs","Number","setInterval","flush","db","getDb","clear"],"sources":["E:/Creative/App/dms/client/src/utils/syncQueue.js"],"sourcesContent":["// File: dms/client/src/utils/syncQueue.js\r\n// REPLACE previous localforage-only version.\r\n// It keeps localforage queue and ALSO writes a SW-readable copy (via idb sw_requests)\r\n// It tries to upload to server; if server returns 5xx or network fails, it attempts to POST to /api/pending\r\nimport localforage from 'localforage';\r\nimport { addSwRequest, deleteSwRequest } from './sw-idb';\r\n\r\nconst QUEUE_KEY = 'dms_sync_queue_v2';\r\nconst PROCESSING_FLAG = 'dms_sync_processing_v2';\r\nlocalforage.config({ name: 'dms', storeName: 'sync_queue' });\r\n\r\nasync function _readQueue(){ const q = await localforage.getItem(QUEUE_KEY); return Array.isArray(q) ? q : []; }\r\nasync function _writeQueue(arr){ await localforage.setItem(QUEUE_KEY, arr || []); }\r\n\r\nexport async function getQueue(){ return await _readQueue(); }\r\n\r\nexport async function enqueue(type, payload){\r\n  const q = await _readQueue();\r\n  const id = `${Date.now()}_${Math.random().toString(36).slice(2,9)}`;\r\n  const item = { id, type, payload, createdAt: new Date().toISOString() };\r\n  q.push(item);\r\n  await _writeQueue(q);\r\n  // also write SW copy for replay\r\n  try { await addSwRequest(item); } catch(e){ console.warn('addSwRequest failed', e); }\r\n  // try to register background sync\r\n  if ('serviceWorker' in navigator && 'SyncManager' in window) {\r\n    try { const reg = await navigator.serviceWorker.ready; await reg.sync.register('dms-sync'); } catch(e){ console.warn('sync register failed', e); }\r\n  }\r\n  if (navigator.onLine) processQueue().catch(()=>{});\r\n  return id;\r\n}\r\n\r\nexport async function removeItemById(id){\r\n  // remove from both localforage queue and SW idb store\r\n  const q = await _readQueue();\r\n  const filtered = q.filter(it => it.id !== id);\r\n  await _writeQueue(filtered);\r\n  try { await deleteSwRequest(id); } catch(e){ /* ignore */ }\r\n}\r\n\r\nasync function _isProcessing(){ return !!(await localforage.getItem(PROCESSING_FLAG)); }\r\nasync function _setProcessing(val){ if (val) await localforage.setItem(PROCESSING_FLAG, true); else await localforage.removeItem(PROCESSING_FLAG); }\r\n\r\nexport async function processQueue(){\r\n  if (await _isProcessing()) return;\r\n  await _setProcessing(true);\r\n  try {\r\n    let q = await _readQueue();\r\n    if (!q.length) return;\r\n    for (const item of [...q]) {\r\n      try {\r\n        if (item.type === 'transaction') {\r\n          const token = localStorage.getItem('token');\r\n          const res = await fetch(`${process.env.REACT_APP_API_BASE || 'http://localhost:4000'}/api/transactions`, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type':'application/json', ...(token ? { Authorization: `Bearer ${token}` } : {}) },\r\n            body: JSON.stringify(item.payload)\r\n          });\r\n          if (!res.ok) {\r\n            // If client is authorized and server returns 5xx (server error), push to server-side pending queue\r\n            if (res.status >= 500) {\r\n              try {\r\n                const uploadRes = await fetch(`${process.env.REACT_APP_API_BASE || 'http://localhost:4000'}/api/pending`, {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type':'application/json', ...(token ? { Authorization: `Bearer ${token}` } : {}) },\r\n                  body: JSON.stringify({ type: item.type, payload: item.payload })\r\n                });\r\n                if (uploadRes.ok) {\r\n                  // remove local queued item and SW stored request\r\n                  await removeItemById(item.id);\r\n                  q = await _readQueue();\r\n                  continue;\r\n                }\r\n              } catch (e) { /* can't reach server to create pending */ }\r\n            }\r\n            // 401 -> wipe auth and stop processing\r\n            if (res.status === 401) { localStorage.removeItem('token'); localStorage.removeItem('user'); throw new Error('Unauthorized'); }\r\n            // 4xx invalid -> drop it\r\n            if (res.status >= 400 && res.status < 500) {\r\n              await removeItemById(item.id);\r\n              q = await _readQueue();\r\n              continue;\r\n            }\r\n            throw new Error('Server error ' + res.status);\r\n          }\r\n          // success: remove both stores (localforage & sw idb)\r\n          await removeItemById(item.id);\r\n          q = await _readQueue();\r\n          // also remove SW copy to avoid double send\r\n          try { await deleteSwRequest(item.id); } catch(e){ /* ignore */ }\r\n          continue;\r\n        } else {\r\n          // unknown type -> remove\r\n          await removeItemById(item.id);\r\n          q = await _readQueue();\r\n          continue;\r\n        }\r\n      } catch (err) {\r\n        console.warn('Queue processing stopped:', err && err.message ? err.message : err);\r\n        break;\r\n      }\r\n    }\r\n  } finally {\r\n    await _setProcessing(false);\r\n  }\r\n}\r\n\r\nexport function startQueueProcessor(opts = {}) {\r\n  if (navigator.onLine) processQueue().catch(()=>{});\r\n  window.addEventListener('online', () => processQueue().catch(()=>{}));\r\n  document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible' && navigator.onLine) processQueue().catch(()=>{}); });\r\n  if (opts.intervalMs && Number(opts.intervalMs) > 0) setInterval(() => { if (navigator.onLine) processQueue().catch(()=>{}); }, Number(opts.intervalMs));\r\n}\r\n\r\nexport async function flush() { await _writeQueue([]); try { const db = await (await import('./sw-idb')).getDb(); await db.clear('sw_requests'); } catch(e){ /* ignore */ } }\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}