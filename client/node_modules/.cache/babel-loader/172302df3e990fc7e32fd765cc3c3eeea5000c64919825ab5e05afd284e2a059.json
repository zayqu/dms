{"ast":null,"code":"// dms/client/src/utils/syncQueue.js\nimport localforage from 'localforage';\nconst QUEUE_KEY = 'dms_sync_queue_v2';\nconst PROCESSING_FLAG = 'dms_sync_processing_v2';\n\n// configure localforage (optional)\nlocalforage.config({\n  name: 'dms',\n  storeName: 'sync_queue'\n});\nasync function _readQueue() {\n  const q = await localforage.getItem(QUEUE_KEY);\n  return Array.isArray(q) ? q : [];\n}\nasync function _writeQueue(arr) {\n  await localforage.setItem(QUEUE_KEY, arr || []);\n}\nexport async function getQueue() {\n  return await _readQueue();\n}\nexport async function enqueue(type, payload) {\n  const q = await _readQueue();\n  const id = `${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;\n  q.push({\n    id,\n    type,\n    payload,\n    createdAt: new Date().toISOString()\n  });\n  await _writeQueue(q);\n  if (navigator.onLine) {\n    processQueue().catch(() => {});\n  }\n  return id;\n}\nexport async function removeItemById(id) {\n  const q = await _readQueue();\n  const filtered = q.filter(item => item.id !== id);\n  await _writeQueue(filtered);\n}\nasync function _isProcessing() {\n  return !!(await localforage.getItem(PROCESSING_FLAG));\n}\nasync function _setProcessing(val) {\n  if (val) await localforage.setItem(PROCESSING_FLAG, true);else await localforage.removeItem(PROCESSING_FLAG);\n}\nexport async function processQueue() {\n  if (await _isProcessing()) return;\n  await _setProcessing(true);\n  try {\n    let q = await _readQueue();\n    if (!q.length) return;\n    for (const item of [...q]) {\n      try {\n        if (item.type === 'transaction') {\n          const token = localStorage.getItem('token');\n          const res = await fetch(`${process.env.REACT_APP_API_BASE || 'http://localhost:4000'}/api/transactions`, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n              ...(token ? {\n                Authorization: `Bearer ${token}`\n              } : {})\n            },\n            body: JSON.stringify(item.payload)\n          });\n          if (!res.ok) {\n            if (res.status === 401) {\n              localStorage.removeItem('token');\n              localStorage.removeItem('user');\n              throw new Error('Unauthorized — stop processing');\n            }\n            if (res.status >= 400 && res.status < 500) {\n              // drop invalid item\n              await removeItemById(item.id);\n              q = await _readQueue();\n              continue;\n            }\n            throw new Error(`Server error ${res.status}`);\n          }\n          // success\n          await removeItemById(item.id);\n          q = await _readQueue();\n          continue;\n        } else {\n          // unknown types – remove\n          await removeItemById(item.id);\n          q = await _readQueue();\n          continue;\n        }\n      } catch (err) {\n        // stop processing and retry later\n        console.warn('Queue processing paused:', err && err.message ? err.message : err);\n        break;\n      }\n    }\n  } finally {\n    await _setProcessing(false);\n  }\n}\nexport function startQueueProcessor(opts = {}) {\n  // run on load\n  if (navigator.onLine) {\n    processQueue().catch(() => {});\n  }\n  window.addEventListener('online', () => {\n    processQueue().catch(() => {});\n  });\n  document.addEventListener('visibilitychange', () => {\n    if (document.visibilityState === 'visible' && navigator.onLine) {\n      processQueue().catch(() => {});\n    }\n  });\n  if (opts.intervalMs && Number(opts.intervalMs) > 0) {\n    setInterval(() => {\n      if (navigator.onLine) processQueue().catch(() => {});\n    }, Number(opts.intervalMs));\n  }\n}\nexport async function flush() {\n  await _writeQueue([]);\n}","map":{"version":3,"names":["localforage","QUEUE_KEY","PROCESSING_FLAG","config","name","storeName","_readQueue","q","getItem","Array","isArray","_writeQueue","arr","setItem","getQueue","enqueue","type","payload","id","Date","now","Math","random","toString","slice","push","createdAt","toISOString","navigator","onLine","processQueue","catch","removeItemById","filtered","filter","item","_isProcessing","_setProcessing","val","removeItem","length","token","localStorage","res","fetch","process","env","REACT_APP_API_BASE","method","headers","Authorization","body","JSON","stringify","ok","status","Error","err","console","warn","message","startQueueProcessor","opts","window","addEventListener","document","visibilityState","intervalMs","Number","setInterval","flush"],"sources":["E:/Creative/App/dms/client/src/utils/syncQueue.js"],"sourcesContent":["// dms/client/src/utils/syncQueue.js\r\nimport localforage from 'localforage';\r\n\r\nconst QUEUE_KEY = 'dms_sync_queue_v2';\r\nconst PROCESSING_FLAG = 'dms_sync_processing_v2';\r\n\r\n// configure localforage (optional)\r\nlocalforage.config({\r\n  name: 'dms',\r\n  storeName: 'sync_queue'\r\n});\r\n\r\nasync function _readQueue() {\r\n  const q = await localforage.getItem(QUEUE_KEY);\r\n  return Array.isArray(q) ? q : [];\r\n}\r\nasync function _writeQueue(arr) {\r\n  await localforage.setItem(QUEUE_KEY, arr || []);\r\n}\r\n\r\nexport async function getQueue() {\r\n  return await _readQueue();\r\n}\r\n\r\nexport async function enqueue(type, payload) {\r\n  const q = await _readQueue();\r\n  const id = `${Date.now()}_${Math.random().toString(36).slice(2,9)}`;\r\n  q.push({ id, type, payload, createdAt: new Date().toISOString() });\r\n  await _writeQueue(q);\r\n  if (navigator.onLine) {\r\n    processQueue().catch(()=>{});\r\n  }\r\n  return id;\r\n}\r\n\r\nexport async function removeItemById(id) {\r\n  const q = await _readQueue();\r\n  const filtered = q.filter(item => item.id !== id);\r\n  await _writeQueue(filtered);\r\n}\r\n\r\nasync function _isProcessing() {\r\n  return !!(await localforage.getItem(PROCESSING_FLAG));\r\n}\r\nasync function _setProcessing(val) {\r\n  if (val) await localforage.setItem(PROCESSING_FLAG, true);\r\n  else await localforage.removeItem(PROCESSING_FLAG);\r\n}\r\n\r\nexport async function processQueue() {\r\n  if (await _isProcessing()) return;\r\n  await _setProcessing(true);\r\n  try {\r\n    let q = await _readQueue();\r\n    if (!q.length) return;\r\n    for (const item of [...q]) {\r\n      try {\r\n        if (item.type === 'transaction') {\r\n          const token = localStorage.getItem('token');\r\n          const res = await fetch(`${process.env.REACT_APP_API_BASE || 'http://localhost:4000'}/api/transactions`, {\r\n            method: 'POST',\r\n            headers: {\r\n              'Content-Type': 'application/json',\r\n              ...(token ? { Authorization: `Bearer ${token}` } : {})\r\n            },\r\n            body: JSON.stringify(item.payload)\r\n          });\r\n          if (!res.ok) {\r\n            if (res.status === 401) {\r\n              localStorage.removeItem('token');\r\n              localStorage.removeItem('user');\r\n              throw new Error('Unauthorized — stop processing');\r\n            }\r\n            if (res.status >= 400 && res.status < 500) {\r\n              // drop invalid item\r\n              await removeItemById(item.id);\r\n              q = await _readQueue();\r\n              continue;\r\n            }\r\n            throw new Error(`Server error ${res.status}`);\r\n          }\r\n          // success\r\n          await removeItemById(item.id);\r\n          q = await _readQueue();\r\n          continue;\r\n        } else {\r\n          // unknown types – remove\r\n          await removeItemById(item.id);\r\n          q = await _readQueue();\r\n          continue;\r\n        }\r\n      } catch (err) {\r\n        // stop processing and retry later\r\n        console.warn('Queue processing paused:', err && err.message ? err.message : err);\r\n        break;\r\n      }\r\n    }\r\n  } finally {\r\n    await _setProcessing(false);\r\n  }\r\n}\r\n\r\nexport function startQueueProcessor(opts = {}) {\r\n  // run on load\r\n  if (navigator.onLine) {\r\n    processQueue().catch(()=>{});\r\n  }\r\n  window.addEventListener('online', () => {\r\n    processQueue().catch(()=>{});\r\n  });\r\n  document.addEventListener('visibilitychange', () => {\r\n    if (document.visibilityState === 'visible' && navigator.onLine) {\r\n      processQueue().catch(()=>{});\r\n    }\r\n  });\r\n  if (opts.intervalMs && Number(opts.intervalMs) > 0) {\r\n    setInterval(() => {\r\n      if (navigator.onLine) processQueue().catch(()=>{});\r\n    }, Number(opts.intervalMs));\r\n  }\r\n}\r\n\r\nexport async function flush() {\r\n  await _writeQueue([]);\r\n}"],"mappings":"AAAA;AACA,OAAOA,WAAW,MAAM,aAAa;AAErC,MAAMC,SAAS,GAAG,mBAAmB;AACrC,MAAMC,eAAe,GAAG,wBAAwB;;AAEhD;AACAF,WAAW,CAACG,MAAM,CAAC;EACjBC,IAAI,EAAE,KAAK;EACXC,SAAS,EAAE;AACb,CAAC,CAAC;AAEF,eAAeC,UAAUA,CAAA,EAAG;EAC1B,MAAMC,CAAC,GAAG,MAAMP,WAAW,CAACQ,OAAO,CAACP,SAAS,CAAC;EAC9C,OAAOQ,KAAK,CAACC,OAAO,CAACH,CAAC,CAAC,GAAGA,CAAC,GAAG,EAAE;AAClC;AACA,eAAeI,WAAWA,CAACC,GAAG,EAAE;EAC9B,MAAMZ,WAAW,CAACa,OAAO,CAACZ,SAAS,EAAEW,GAAG,IAAI,EAAE,CAAC;AACjD;AAEA,OAAO,eAAeE,QAAQA,CAAA,EAAG;EAC/B,OAAO,MAAMR,UAAU,CAAC,CAAC;AAC3B;AAEA,OAAO,eAAeS,OAAOA,CAACC,IAAI,EAAEC,OAAO,EAAE;EAC3C,MAAMV,CAAC,GAAG,MAAMD,UAAU,CAAC,CAAC;EAC5B,MAAMY,EAAE,GAAG,GAAGC,IAAI,CAACC,GAAG,CAAC,CAAC,IAAIC,IAAI,CAACC,MAAM,CAAC,CAAC,CAACC,QAAQ,CAAC,EAAE,CAAC,CAACC,KAAK,CAAC,CAAC,EAAC,CAAC,CAAC,EAAE;EACnEjB,CAAC,CAACkB,IAAI,CAAC;IAAEP,EAAE;IAAEF,IAAI;IAAEC,OAAO;IAAES,SAAS,EAAE,IAAIP,IAAI,CAAC,CAAC,CAACQ,WAAW,CAAC;EAAE,CAAC,CAAC;EAClE,MAAMhB,WAAW,CAACJ,CAAC,CAAC;EACpB,IAAIqB,SAAS,CAACC,MAAM,EAAE;IACpBC,YAAY,CAAC,CAAC,CAACC,KAAK,CAAC,MAAI,CAAC,CAAC,CAAC;EAC9B;EACA,OAAOb,EAAE;AACX;AAEA,OAAO,eAAec,cAAcA,CAACd,EAAE,EAAE;EACvC,MAAMX,CAAC,GAAG,MAAMD,UAAU,CAAC,CAAC;EAC5B,MAAM2B,QAAQ,GAAG1B,CAAC,CAAC2B,MAAM,CAACC,IAAI,IAAIA,IAAI,CAACjB,EAAE,KAAKA,EAAE,CAAC;EACjD,MAAMP,WAAW,CAACsB,QAAQ,CAAC;AAC7B;AAEA,eAAeG,aAAaA,CAAA,EAAG;EAC7B,OAAO,CAAC,EAAE,MAAMpC,WAAW,CAACQ,OAAO,CAACN,eAAe,CAAC,CAAC;AACvD;AACA,eAAemC,cAAcA,CAACC,GAAG,EAAE;EACjC,IAAIA,GAAG,EAAE,MAAMtC,WAAW,CAACa,OAAO,CAACX,eAAe,EAAE,IAAI,CAAC,CAAC,KACrD,MAAMF,WAAW,CAACuC,UAAU,CAACrC,eAAe,CAAC;AACpD;AAEA,OAAO,eAAe4B,YAAYA,CAAA,EAAG;EACnC,IAAI,MAAMM,aAAa,CAAC,CAAC,EAAE;EAC3B,MAAMC,cAAc,CAAC,IAAI,CAAC;EAC1B,IAAI;IACF,IAAI9B,CAAC,GAAG,MAAMD,UAAU,CAAC,CAAC;IAC1B,IAAI,CAACC,CAAC,CAACiC,MAAM,EAAE;IACf,KAAK,MAAML,IAAI,IAAI,CAAC,GAAG5B,CAAC,CAAC,EAAE;MACzB,IAAI;QACF,IAAI4B,IAAI,CAACnB,IAAI,KAAK,aAAa,EAAE;UAC/B,MAAMyB,KAAK,GAAGC,YAAY,CAAClC,OAAO,CAAC,OAAO,CAAC;UAC3C,MAAMmC,GAAG,GAAG,MAAMC,KAAK,CAAC,GAAGC,OAAO,CAACC,GAAG,CAACC,kBAAkB,IAAI,uBAAuB,mBAAmB,EAAE;YACvGC,MAAM,EAAE,MAAM;YACdC,OAAO,EAAE;cACP,cAAc,EAAE,kBAAkB;cAClC,IAAIR,KAAK,GAAG;gBAAES,aAAa,EAAE,UAAUT,KAAK;cAAG,CAAC,GAAG,CAAC,CAAC;YACvD,CAAC;YACDU,IAAI,EAAEC,IAAI,CAACC,SAAS,CAAClB,IAAI,CAAClB,OAAO;UACnC,CAAC,CAAC;UACF,IAAI,CAAC0B,GAAG,CAACW,EAAE,EAAE;YACX,IAAIX,GAAG,CAACY,MAAM,KAAK,GAAG,EAAE;cACtBb,YAAY,CAACH,UAAU,CAAC,OAAO,CAAC;cAChCG,YAAY,CAACH,UAAU,CAAC,MAAM,CAAC;cAC/B,MAAM,IAAIiB,KAAK,CAAC,gCAAgC,CAAC;YACnD;YACA,IAAIb,GAAG,CAACY,MAAM,IAAI,GAAG,IAAIZ,GAAG,CAACY,MAAM,GAAG,GAAG,EAAE;cACzC;cACA,MAAMvB,cAAc,CAACG,IAAI,CAACjB,EAAE,CAAC;cAC7BX,CAAC,GAAG,MAAMD,UAAU,CAAC,CAAC;cACtB;YACF;YACA,MAAM,IAAIkD,KAAK,CAAC,gBAAgBb,GAAG,CAACY,MAAM,EAAE,CAAC;UAC/C;UACA;UACA,MAAMvB,cAAc,CAACG,IAAI,CAACjB,EAAE,CAAC;UAC7BX,CAAC,GAAG,MAAMD,UAAU,CAAC,CAAC;UACtB;QACF,CAAC,MAAM;UACL;UACA,MAAM0B,cAAc,CAACG,IAAI,CAACjB,EAAE,CAAC;UAC7BX,CAAC,GAAG,MAAMD,UAAU,CAAC,CAAC;UACtB;QACF;MACF,CAAC,CAAC,OAAOmD,GAAG,EAAE;QACZ;QACAC,OAAO,CAACC,IAAI,CAAC,0BAA0B,EAAEF,GAAG,IAAIA,GAAG,CAACG,OAAO,GAAGH,GAAG,CAACG,OAAO,GAAGH,GAAG,CAAC;QAChF;MACF;IACF;EACF,CAAC,SAAS;IACR,MAAMpB,cAAc,CAAC,KAAK,CAAC;EAC7B;AACF;AAEA,OAAO,SAASwB,mBAAmBA,CAACC,IAAI,GAAG,CAAC,CAAC,EAAE;EAC7C;EACA,IAAIlC,SAAS,CAACC,MAAM,EAAE;IACpBC,YAAY,CAAC,CAAC,CAACC,KAAK,CAAC,MAAI,CAAC,CAAC,CAAC;EAC9B;EACAgC,MAAM,CAACC,gBAAgB,CAAC,QAAQ,EAAE,MAAM;IACtClC,YAAY,CAAC,CAAC,CAACC,KAAK,CAAC,MAAI,CAAC,CAAC,CAAC;EAC9B,CAAC,CAAC;EACFkC,QAAQ,CAACD,gBAAgB,CAAC,kBAAkB,EAAE,MAAM;IAClD,IAAIC,QAAQ,CAACC,eAAe,KAAK,SAAS,IAAItC,SAAS,CAACC,MAAM,EAAE;MAC9DC,YAAY,CAAC,CAAC,CAACC,KAAK,CAAC,MAAI,CAAC,CAAC,CAAC;IAC9B;EACF,CAAC,CAAC;EACF,IAAI+B,IAAI,CAACK,UAAU,IAAIC,MAAM,CAACN,IAAI,CAACK,UAAU,CAAC,GAAG,CAAC,EAAE;IAClDE,WAAW,CAAC,MAAM;MAChB,IAAIzC,SAAS,CAACC,MAAM,EAAEC,YAAY,CAAC,CAAC,CAACC,KAAK,CAAC,MAAI,CAAC,CAAC,CAAC;IACpD,CAAC,EAAEqC,MAAM,CAACN,IAAI,CAACK,UAAU,CAAC,CAAC;EAC7B;AACF;AAEA,OAAO,eAAeG,KAAKA,CAAA,EAAG;EAC5B,MAAM3D,WAAW,CAAC,EAAE,CAAC;AACvB","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}